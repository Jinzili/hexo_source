---
title: Java类加载机制
date: 2018-06-30 10:49:31
tags: ["类加载"]
categories: "JavaBase"
---
## 类的加载
Java类的加载指的是将类的.class文件中的二进制数据读入到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个java.lang.Class对象，用来封装类在方法区内的数据结构。类的加载的最终产品是位于堆区中的Class对象，Class对象封装了类在方法区内的数据结构，并且向外部提供了访问方法区内的数据结构的接口。
## 类的生命周期
![image](https://cloud.gemii.cc/lizcloud/fs/noauth/media/5ac34bc01e6d8a0037546f1b)
类从被加载到虚拟机内存中开始，到卸载出内存为止，它的生命周期包括：加载、验证、准备、解析、初始化、使用和卸载7个阶段。其中验证、准备、解析统称为连接。
加载、验证、准备、初始化和卸载这5个阶段的顺序是确定的，类的加载过程必须按照这种顺序按部就班的开始，而解析则不一定，它在某些情况下可以在初始化阶段之后再开始，这是为了支持Java的运行时绑定。
### 加载
加载阶段，虚拟机需要完成以下3件事情：

- 通过一个类的全限定名来获取定义此类的二进制字节流

> 加载.class文件的方式
> 1. 从本地系统中直接加载
> 2. 通过网络下载
> 3. 从zip，jar等归档文件中加载.class文件
> 4. 从专有数据库中提取
> 5. 将Java源文件动态编译为.class文件

- 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构
- 在内存中生成一个代表这个类的java.lang.Class对象，作为方法去这个类的各种数据的访问入口

加载和连接阶段的部分内容是交叉进行的，加载阶段尚未完成，连接阶段可能已经开始（如一部分字节码文件格式验证），但是这些动作仍然属于连接阶段的内容，这两个阶段的开始时间仍然保持着固定的先后顺序。

加载阶段既可以使用系统提供的类加载器来完成加载，也可以自定义自己的类加载器。

加载阶段完成后，虚拟机外部的二进制字节流就按照虚拟机所需的格式存储在方法区之中，而且在Java堆中也创建一个java.lang.Class对象，这样便可以通过该对象访问方法区中的这些数据。

### 连接
#### 验证
验证是连接阶段的第一步，这一步的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。

主要完成4个检验动作：
- 文件格式验证：验证自己留是否符合Class文件格式的规范，例如是否以0xCAFABABE开头（传说中的魔数）、主次版本号是否在当前虚拟机的处理范围之内、常量池中的敞亮是否有不被支持的类型。
- 元数据验证：对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言的规范；例如这个类是否有父类（除了java.lang.Object）
- 字节码验证：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的
- 符号引用验证：确保解析动作能正确执行

验证阶段是非常重要的，但不是必须的，它对程序运行期没有影响，如果所引用的类经过反复验证，那么可以考虑采用-Xverifynone参数来关闭大部分的类验证措施，以缩短虚拟机类加载的时间。
#### 准备
为类的静态变量分配内存，并将其初始化为默认值，正式为类变量分配内存并设置类变量初始值的阶段，这些内存都将在方法区中分配。

有几点需要注意：
- 这时候进行内存分配的仅包括类变量（static），不包括实例变量，实例变量将在对象实例化时随着对象一块分配在Java堆中。
- 这是所设置的初始值通常情况下是数据类型默认的零值（如0、0L、null、false等），而不是代码中被显示赋予的值。

假如一个类变量的定义为：
public static int value = 7
那么在准备阶段过后value的初始值为0，而不是7，这时候还未执行任何Java方法，把value赋值为7的动作将在初始化阶段才会执行。特殊情况：加载final关键词后，即当类字段的字段属性是ConstantValue时，会在准备阶段初始化为指定的值，所以标注final后，value的值在此阶段初始化为7而不是0。
#### 解析

解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程，解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行。符号引用就是一组符号来描述模板，可以是任何字面量。
直接引用就是直接指向模板的指针、相对偏移量或一个简洁定位到目标的句柄。
### 初始化
为类的静态变量赋予正确的初始值，JVM负责对类进行初始化，主要对类变量进行初始化。对类变量进行初始值设定有两种方式：
- 声明类变量是指定初始值
- 使用静态代码块为类变量指定初始值

JVM初始化步骤：
1. 假如这个类还没有被加载和连接，则程序先加载并连接该类
2. 假如该类的直接父类还没有被初始化，则先初始化其直接父类
3. 假如类中有初始化语句，则系统依次执行这些初始化语句

类初始化时机（只有当对类的主动使用的时候才会导致类的初始化）：
- 创建类的实例，new Example()
- 访问某个类或接口的静态变量，或者对该静态变量进行赋值
- 调用类的静态方法
- 反射（Class.forName("...")）
- 初始化某个类的子类，则其父类也会被初始化
- Java虚拟机启动时被标明为启动类的类，直接使用java.exe命令来运行某个主类

